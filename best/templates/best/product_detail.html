{% extends 'base.html' %}

{% block content %}
<div style="height: 100px;"></div>
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
</head>

<style>
    /* Jua í°íŠ¸ë¥¼ ì ìš©í•  CSS ìŠ¤íƒ€ì¼ */
    body, .jua-regular {
        font-family: "Jua", sans-serif;
        font-weight: 200;
        font-style: normal;
    }
    .product-image {
        display: block;
        width: 300px;
        height: auto;
        margin: 0 auto;
    }

    .name {
        font-size: 20px;
        margin-top: 10px;
        font-weight: bold;
        text-align: center;
    }

    .avg_score {
        font-size: 24px;
        margin-top: 10px;
    }

    .recommend {
        font-size: 14px;
        text-align: center;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        height: 100px;
    }

    th, td {
        border: 1px solid black;
        padding: 0px;
        text-align: center;
        font-size: 14px;
        height: 30px;
    }

    th:first-child, td:nth-child(3),
    td:first-child {
        text-align: center;
        font-weight: bold;
    }

    td:first-child, td:nth-child(3) {
        font-size: 14px;
        background-color: #e9ecef;
    }

    .nutrient {
        width: 100%;
        height: 100px;
        display: plex;
    }

    tr:nth-child(1) > th {
        text-align: right;
        font-size: 13px;
        padding-right: 20px;
        border: none;
    }
    .box1 { 
        color: black;
        text-align:center;
    }

    .gptTable {
        display: flex;
        flex-direction: column;
        border: 0.1rem solid #e6e6e6;
        background-color: #ffffff;
        border-radius: 1rem; /* ì›í•˜ëŠ” ì •ë„ì˜ ë‘¥ê·¼ ì •ë„ë¡œ ì¡°ì • */
        margin: 1.2rem 2rem 0.2rem;
        padding: 1.6rem;
        padding-bottom: 0;
        margin: 0 2rem;
    }

    .gptImgText {
        display: flex;
        align-items: center;
        height: 2rem;
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.7rem;
        color: #1a1a1a;
        position: relative;
    }
    


    .gptImg {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 2rem;
        width: 2rem;
        margin-right: 0.6rem;
        pointer-events: none;
    }
    
    .gptImg {
        content: '';
        display: flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        background-image: url('https://yaimg.yanolja.com/stay/static/images/img_ai_emoji-48.gif');
        background-repeat: no-repeat;
        background-size: 2.2rem;
        background-position: center;
        border-radius: 50%;
        overflow: hidden;
    }


    .pone {
        display: flex;
        position: relative;
        align-items: center;
        background-color: #f2f2f2;
        border: 0.1rem solid #e6e6e6;
        border-radius: 0.6rem 0.6rem 0 0;
        height: 2.8rem;
        margin-top: 1.1rem;
        box-sizing: border-box;
        user-select: none;
    }
    
    .pone > div {
        flex: 1;
        display: flex;
        position: absolute;
        width: 50%;
        height: 100%;
        top: 0;
        align-items: center;
        justify-content: center;
        font-size: 1.0rem;
        font-weight: normal;
        line-height: 1.4rem;
        color: #1a1a1a;
        cursor: pointer;
    }
    
    .pone > div.selected {
        font-weight: 400;
        background-color: white; /* ì„ íƒëœ ë²„íŠ¼ì˜ ë°°ê²½ìƒ‰ì„ í°ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
    }
    
    .pone > div:nth-of-type(n + 2) {
        left: 50%;
    }
    
    .pone:before {
        content: '';
        display: flex;
        position: absolute;
        flex: 1;
        left: -0.1rem;
        top: -0.1rem;
        width: 50%;
        height: calc(100% + 0.2rem);
        background-color: #f2f2f2;
        border: 0.1rem solid #e6e6e6;
        border-bottom: 0.1rem solid #ffffff;
        border-radius: 0.6rem 0.6rem 0 0;
        transition: left 100ms ease-in-out;
    }
    
    
    /* ì„ íƒëœ í•­ëª©ì„ ê°•ì¡°í•˜ëŠ” ìŠ¤íƒ€ì¼ */
.selected {
    font-weight: bold;
}

/* ìˆ¨ê²¨ì§„ ìš”ì†Œ */
.hidden {
    display: none;
}

.content {
    margin: 15px 10px; /* ìœ„ì•„ë˜ 10px, ì¢Œìš° 5pxì˜ ë§ˆì§„ì„ ì¶”ê°€ */
}


</style>

<a href="{{product.site_url}}" class="box1">
    <img src="{{product.image_url}}" class="product-image">
    <p >í•´ë‹¹ ì œí’ˆ ì‚¬ì´íŠ¸ë¡œ ì´ë™ â–¶ï¸</p>
</a>

<div class="like-container">
    <button class="like-button" data-product-id="{{ product.product_id }}">
        {% if user.is_authenticated %}
            {% if is_liked %}
                ì¢‹ì•„ìš” ì·¨ì†Œ
            {% else %}
                ì¢‹ì•„ìš”
            {% endif %}
        {% else %}
            ì¢‹ì•„ìš”
        {% endif %}
    </button>
</div>

<div class="name-container">
    <p class="name">
        <span class="heart-icon">
            {% if is_liked %}
                â¤ï¸
            {% else %}
                ğŸ–¤
            {% endif %}
        </span>
        [{{ product.patient_category }}] {{ product.product_name }}
    </p>
</div>

<canvas id="myChart" width="400" height="200"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    {% if product.patient_category == 'ë‹¹ë‡¨' %}
    let myCt = document.getElementById('myChart');
    let myChart = new Chart(myCt, {
        type: 'bar',
        options: {
            indexAxis: 'y',
            plugins: {
                subtitle: {
                    display: true,
                    text: '[ë‹¹ë‡¨í™˜ìë¥¼ ìœ„í•œ ë‹¹ í•¨ëŸ‰ ê¸°ì¤€ í‘œ(g)]'
                }
            }
        },
        data: {
            labels: ['ë‹¹ ê¶Œì¥ ì„­ì·¨ëŸ‰', 'í•´ë‹¹ìƒí’ˆ', 'ë‹¹ì‚¬ í‰ê· '],
            datasets: [
                {
                    label: '65kg ì„±ì¸ í•œë¼ ê¸°ì¤€',
                    data: [3.33, {{ product.sugars }}, {{ avg_sugars|default:0 }}],
                    backgroundColor: ['#ccfcfc', '#2ecc71', '#ccfcfc'],
                    borderColor: 'white',
                    maxBarThickness: 30
                }
            ]
        },
    });
    {% endif %}

    {% if product.patient_category == 'ì‹ ì¥ì§ˆí™˜' %}
    let myCt = document.getElementById('myChart');
    let myChart = new Chart(myCt, {
        type: 'bar',
        options: {
            indexAxis: 'y',
            plugins: {
                subtitle: {
                    display: true,
                    text: 'ì‹ ì¥ì§ˆí™˜ìë¥¼ ìœ„í•œ ë‚˜íŠ¸ë¥¨ ê¸°ì¤€ í‘œ(mg)'
                }
            }
        },
        data: {
            labels: ['ë‚˜íŠ¸ë¥¨ ê¶Œì¥ ì„­ì·¨ëŸ‰', 'í•´ë‹¹ìƒí’ˆ', 'ë‹¹ì‚¬ í‰ê· '],
            datasets: [
                {
                    label: '65kg ì„±ì¸ í•œë¼ ê¸°ì¤€',
                    data: [266, {{ product.na }}, {{ avg_na|default:0 }}],
                    backgroundColor: ['#ccfcfc', '#2ecc71', '#ccfcfc'],
                    borderColor: 'white',
                    borderWidth: 2,
                    maxBarThickness: 30
                }
            ]
        },
    });
    {% endif %}

    {% if product.patient_category == 'ì•”ì§ˆí™˜' %}
    let myCt = document.getElementById('myChart');
    let myChart = new Chart(myCt, {
        type: 'bar',
        options: {
            indexAxis: 'y',
            plugins: {
                subtitle: {
                    display: true,
                    text: 'ì•” ì§ˆí™˜ìë¥¼ ìœ„í•œ ë‹¨ë°±ì§ˆ ìœ ë˜ì—´ëŸ‰ ê¸°ì¤€í‘œ(kcal)'
                }
            }
        },
        data: {
            labels: ['ìµœì†Œê¸°ì¤€ì¹˜ ', 'í•´ë‹¹ ìƒí’ˆ', 'ë‹¹ì‚¬ í‰ê· '],
            datasets: [
                {
                    label: '65kg ì„±ì¸ í•œë¼ ê¸°ì¤€',
                    data: [{{product.calorie}} * 0.18 , {{product.protein}} * 4 , {{ avg_protein|default:0 }} *4], // ë‹¨ë°±ì§ˆì€ 1gë‹¹ 4kcal (ìœ ë˜ì—´ëŸ‰), ê¸°ì¤€ì¹˜ ì—´ëŸ‰ì˜ 18% ì´ìƒ ( ì¹¼ë¡œë¦¬ * 0.18 )
                    backgroundColor: ['#ccfcfc', '#2ecc71', '#ccfcfc'],
                    borderColor: 'white',
                    borderWidth: 2,
                    maxBarThickness: 30
                }
            ]
        },
    });
    {% endif %}
</script>

{% if product.patient_category == 'ë‹¹ë‡¨' %}
    <p class="recommend">ë‹¹ë‡¨í™˜ìê°€ ìœ ì˜í•´ì•¼ í•  ì˜ì–‘ì„±ë¶„ì€ <b>'ë‹¹'</b> ì…ë‹ˆë‹¤</p>
{% endif %}

{% if product.patient_category == 'ì‹ ì¥ì§ˆí™˜' %}
    <p class="recommend">ì‹ ì¥ì§ˆí™˜ìê°€ ìœ ì˜í•´ì•¼ í•  ì˜ì–‘ì„±ë¶„ì€ <b>'ë‚˜íŠ¸ë¥¨'</b> ì…ë‹ˆë‹¤ </p>
{% endif %}

{% if product.patient_category == 'ì•”ì§ˆí™˜' %}
    <p class="recommend">ì•”ì§ˆí™˜ìê°€ ìœ ì˜í•´ì•¼ í•  ì˜ì–‘ì„±ë¶„ì€ <b>'ë‹¨ë°±ì§ˆ'</b> ì…ë‹ˆë‹¤ </p>
{% endif %}

<div class="nutrient">
    <table>
        <tbody>
            <tr>
                <th colspan="2" style="text-align:left;">
                    ì˜ì–‘ì„±ë¶„í‘œ
                </th>
                <th colspan="2">
                    (100gê¸°ì¤€)
                </th>
            </tr>
            <tr>
                <td>ì—´ëŸ‰</td>
                <td>{{ product.calorie }} (kcal)</td>
                <td>íƒ„ìˆ˜í™”ë¬¼</td>
                <td>{{ product.carbohydrate }} (g)</td>
            </tr>
            <tr>
                <td>ë‹¨ë°±ì§ˆ</td>
                <td>{{ product.protein }} (g)</td>
                <td>ì§€ë°©</td>
                <td>{{ product.fat }} (g)</td>
            </tr>
            <tr>
                <td>ë‹¹</td>
                <td>{{ product.sugars }} (g)</td>
                <td>ë‚˜íŠ¸ë¥¨</td>
                <td>{{ product.na }} (mg)</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    $(document).ready(function() {
        $('.like-button').click(function() {
            var button = $(this);
            var productId = button.data('product-id');

            $.ajax({
                url: '/main/product/' + productId + '/like/',
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (button.text() === 'ì¢‹ì•„ìš”') {
                        button.text('ì¢‹ì•„ìš” ì·¨ì†Œ');
                        $('.heart-icon').text('â¤ï¸');
                    } else {
                        button.text('ì¢‹ì•„ìš”');
                        $('.heart-icon').text('ğŸ–¤');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ì¢‹ì•„ìš” í† ê¸€ ì—ëŸ¬:', error);
                }
            });
        });
    });

    
    
</script>
<div style="height: 50px;"></div>
{% if product.gpt_positive %}  

<div class = "gptTable">
    
    <div class = "gptImgText">
        <div class = "gptImg"> </div>
        <div class = "gptInfo">ChatGPTë¡œ ë¦¬ë·°ë¥¼ ìš”ì•½í•´ë´¤ì–´ìš”</div>
    </div>

 
    <!-- ë²„íŠ¼ë“¤ -->
<div class="pone"> 
    <div class="selected" id="positiveReviewButton">ê¸ì • ë¦¬ë·° ìš”ì•½</div>
    <div id="negativeReviewButton">ë¶€ì • ë¦¬ë·° ìš”ì•½</div>
</div>

<!-- ë‚´ìš© -->
<div id="positiveReviewContent" class="content">{{product.gpt_positive}}</div>
<div id="negativeReviewContent" class="content hidden">{{product.gpt_negative}}</div>
{% else %}
{% endif %}
<script>
// ë²„íŠ¼ ìš”ì†Œì™€ ë‚´ìš© ìš”ì†Œë¥¼ ê°€ì ¸ì˜´
const positiveButton = document.getElementById('positiveReviewButton');
const negativeButton = document.getElementById('negativeReviewButton');
const positiveContent = document.getElementById('positiveReviewContent');
const negativeContent = document.getElementById('negativeReviewContent');

// ê¸ì • ë¦¬ë·° ë²„íŠ¼ í´ë¦­ ì‹œ
positiveButton.addEventListener('click', function() {
    positiveButton.classList.add('selected'); // ì„ íƒëœ ìŠ¤íƒ€ì¼ ì ìš©
    negativeButton.classList.remove('selected'); // ì„ íƒë˜ì§€ ì•Šì€ ìŠ¤íƒ€ì¼ ì œê±°
    positiveContent.classList.remove('hidden'); // ë‚´ìš© ë³´ì´ê¸°
    negativeContent.classList.add('hidden'); // ë‹¤ë¥¸ ë‚´ìš© ìˆ¨ê¸°ê¸°
});

// ë¶€ì • ë¦¬ë·° ë²„íŠ¼ í´ë¦­ ì‹œ
negativeButton.addEventListener('click', function() {
    negativeButton.classList.add('selected'); // ì„ íƒëœ ìŠ¤íƒ€ì¼ ì ìš©
    positiveButton.classList.remove('selected'); // ì„ íƒë˜ì§€ ì•Šì€ ìŠ¤íƒ€ì¼ ì œê±°
    negativeContent.classList.remove('hidden'); // ë‚´ìš© ë³´ì´ê¸°
    positiveContent.classList.add('hidden'); // ë‹¤ë¥¸ ë‚´ìš© ìˆ¨ê¸°ê¸°
});
</script>












</div>

<div style="height: 60px;"></div>

{% endblock %}


